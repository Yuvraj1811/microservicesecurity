name: Deploy to Test & DAST

on:
  workflow_run:
    workflows: ["Build, Image Scan, Push to ACR"]
    types: [completed]

env:
  BACKEND_IMAGE: ${{ secrets.ACR_REGISTRY }}/backend:${{ github.sha }}
  FRONTEND_IMAGE: ${{ secrets.ACR_REGISTRY }}/frontend:${{ github.sha }}

jobs:

  azure-login:
    name: Azure Login
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ env.BACKEND_IMAGE }}
      frontend_image: ${{ env.FRONTEND_IMAGE }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

  deploy-backend:
    needs: azure-login
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend via Azure VM Run Command
        run: |
          az vm run-command invoke \
            --name ${{ secrets.BE_VM_NAME }} \
            --resource-group ${{ secrets.BE_VM_RG }} \
            --command-id RunShellScript \
            --scripts "
              sudo apt-get update
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl enable --now docker
              mkdir -p /home/${{ secrets.BE_VM_USERNAME }}/app
              cd /home/${{ secrets.BE_VM_USERNAME }}/app
              az acr login --name acrinfra1
              docker pull ${{ env.BACKEND_IMAGE }}
              docker compose -f docker-compose.backend.yml up -d --remove-orphans
            "

  deploy-frontend:
    needs: azure-login
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Frontend via Azure VM Run Command
        run: |
          az vm run-command invoke \
            --name ${{ secrets.FE_VM_NAME }} \
            --resource-group ${{ secrets.FE_VM_RG }} \
            --command-id RunShellScript \
            --scripts "
              sudo apt-get update
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl enable --now docker
              mkdir -p /home/${{ secrets.FE_VM_USERNAME }}/app
              cd /home/${{ secrets.FE_VM_USERNAME }}/app
              az acr login --name acrinfra1
              docker pull ${{ env.FRONTEND_IMAGE }}
              docker compose -f docker-compose.frontend.yml up -d --remove-orphans
            "

  dast:
    needs:
      - deploy-backend
      - deploy-frontend
    runs-on: ubuntu-latest
    steps:
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: "http://${{ secrets.FE_VM_PUBLIC_IP }}"

      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: '*.html'
